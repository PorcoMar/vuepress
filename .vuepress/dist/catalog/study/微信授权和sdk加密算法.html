<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PorcoMar Site | ➹ 微信授权和sdk加密算法</title>
    <meta name="description" content="Settle 🍀DUO in a golden house~👺">
    <link rel="shortcut icon" type="image/x-icon" href="https://gitee.com/uploads/6/1023506_PorcoMar.png?1500276509&quot; rel=&quot;shortcut icon">
    
    <link rel="preload" href="/assets/css/10.styles.322416e2.css" as="style"><link rel="preload" href="/assets/js/app.73344881.js" as="script"><link rel="preload" href="/assets/js/0.c2df6edd.js" as="script"><link rel="prefetch" href="/assets/js/5.64c07d37.js"><link rel="prefetch" href="/assets/js/1.56a7da20.js"><link rel="prefetch" href="/assets/js/2.3b4709dc.js"><link rel="prefetch" href="/assets/js/3.6f040e9c.js"><link rel="prefetch" href="/assets/js/4.84736aa4.js"><link rel="prefetch" href="/assets/js/6.86381ce2.js"><link rel="prefetch" href="/assets/js/7.7bd9e25c.js"><link rel="prefetch" href="/assets/js/8.7c781e0a.js"><link rel="prefetch" href="/assets/js/9.91fdac35.js">
    <link rel="stylesheet" href="/assets/css/10.styles.322416e2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      PorcoMar Site
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/catalog/study/" class="nav-link router-link-active">Study</a></div><div class="nav-item"><a href="http://www.porcofish.net:1314/" target="_blank" rel="noopener noreferrer" class="nav-link">About</a></div><div class="nav-item"><a href="https://gitee.com/PorcoMar" target="_blank" rel="noopener noreferrer" class="nav-link">Gitee</a></div><div class="nav-item"><a href="https://github.com/PorcoMar?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/catalog/study/" class="nav-link router-link-active">Study</a></div><div class="nav-item"><a href="http://www.porcofish.net:1314/" target="_blank" rel="noopener noreferrer" class="nav-link">About</a></div><div class="nav-item"><a href="https://gitee.com/PorcoMar" target="_blank" rel="noopener noreferrer" class="nav-link">Gitee</a></div><div class="nav-item"><a href="https://github.com/PorcoMar?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>开发笔记</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/catalog/study/" class="sidebar-link">➹ study目录说明</a></li><li><a href="/catalog/study/vuepress使用说明.html" class="sidebar-link">➹ vuePress使用说明</a></li><li><a href="/catalog/study/微信授权和sdk加密算法.html" class="active sidebar-link">➹ 微信授权和sdk加密算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#➣-准备工作：" class="sidebar-link">➣ 准备工作：</a></li><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#➣-微信网页授权" class="sidebar-link">➣ 微信网页授权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#网页授权回调域名的说明" class="sidebar-link">网页授权回调域名的说明</a></li><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#网页授权的两种scope的区别（snsapi-base-snsapi-userinfo）" class="sidebar-link">网页授权的两种scope的区别（snsapi_base snsapi_userinfo）</a></li><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#网页授权access-token和普通access-token的区别" class="sidebar-link">网页授权access_token和普通access_token的区别</a></li></ul></li><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#➣-具体步骤：" class="sidebar-link">➣ 具体步骤：</a></li><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#代码配置：" class="sidebar-link">* 代码配置：</a></li><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#以snsapi-base为scope发起的授权" class="sidebar-link">* 以snsapi_base为scope发起的授权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#第一步：用户同意授权，获取code" class="sidebar-link">第一步：用户同意授权，获取code</a></li><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#第二步：通过code换取网页授权access-token" class="sidebar-link">第二步：通过code换取网页授权access_token</a></li><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#第三步：拉取用户信息-需scope为-snsapi-userinfo" class="sidebar-link">第三步：拉取用户信息(需scope为 snsapi_userinfo)</a></li></ul></li><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#以snsapi-userinfo为scope发起的授权" class="sidebar-link">* 以snsapi_userinfo为scope发起的授权</a></li><li class="sidebar-sub-header"><a href="/catalog/study/微信授权和sdk加密算法.html#注释：" class="sidebar-link">注释：</a></li></ul></li><li><a href="/catalog/study/browserify+gulp自动编译打包.html" class="sidebar-link">➹ browserify+gulp自动编译打包</a></li><li><a href="/catalog/study/使用webpack配置MPA.html" class="sidebar-link">➹ 使用webpack配置MPA</a></li><li><a href="/catalog/study/Markdown笔记.html" class="sidebar-link">➹ Markdown笔记</a></li><li><a href="/catalog/study/WePY总结.html" class="sidebar-link">➹ WePY总结</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h2 id="➣-准备工作："><a href="#➣-准备工作：" aria-hidden="true" class="header-anchor">#</a> ➣ 准备工作：</h2><ul><li>申请服务器 公众号 基本配置 这些<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1472017492_58YV5" target="_blank" rel="noopener noreferrer">微信公众平台</a>上都有，就不介绍了，接下来进入正题。</li></ul><h2 id="➣-微信网页授权"><a href="#➣-微信网页授权" aria-hidden="true" class="header-anchor">#</a> ➣ 微信网页授权</h2><div class="danger custom-block"><p class="custom-block-title">node js-sdk 授权</p><ul><li><a href="/catalog/study/微信授权和sdk加密算法.html" class="router-link-exact-active router-link-active">公众平台的技术文档目的为了简明扼要的交代接口的使用，语句难免晦涩，这里写了些了我所理解的微信开放平台中关于利用node.js使用授权和js-sdk的一些方法，详情请见微信公众平台.如果用户在微信客户端中访问第三方网页，公众号可以通过微信网页授权机制，来获取用户基本信息，进而实现业务逻辑。随着微信管控越发严厉，像一些最基本的网页转发都需要授权处理才能获取到图片和描述，描述审查也是相当严格。#</a></li></ul></div><h3 id="网页授权回调域名的说明"><a href="#网页授权回调域名的说明" aria-hidden="true" class="header-anchor">#</a> 网页授权回调域名的说明</h3><ul><li><p>在微信公众号请求用户网页授权之前，开发者需要先到公众平台官网中的“开发 - 接口权限 - 网页服务 - 网页帐号 - 网页授权获取用户基本信息”的配置选项中，修改授权回调域名。请注意，这里填写的是域名（是一个字符串），而不是URL，因此请勿加 http:// 等协议头；</p></li><li><p>授权回调域名配置规范为全域名，比如需要网页授权的域名为：www.qq.com，配置以后此域名下面的页面http://www.qq.com/music.html 、 http://www.qq.com/login.html 都可以进行OAuth2.0鉴权。但http://pay.qq.com 、 http://music.qq.com 、 http://qq.com无法进行OAuth2.0鉴权</p></li></ul><hr><h3 id="网页授权的两种scope的区别（snsapi-base-snsapi-userinfo）"><a href="#网页授权的两种scope的区别（snsapi-base-snsapi-userinfo）" aria-hidden="true" class="header-anchor">#</a> 网页授权的两种scope的区别（snsapi_base snsapi_userinfo）</h3><ul><li><p>以snsapi_base为scope发起的网页授权，是用来获取进入页面的用户的openid的，并且是静默授权并自动跳转到回调页的。用户感知的就是直接进入了回调页（往往是业务页面）</p></li><li><p>以snsapi_userinfo为scope发起的网页授权，是用来获取用户的基本信息的。但这种授权需要用户手动同意，并且由于用户同意过，所以无须关注，就可在授权后获取该用户的基本信息。</p></li></ul><hr><h3 id="网页授权access-token和普通access-token的区别"><a href="#网页授权access-token和普通access-token的区别" aria-hidden="true" class="header-anchor">#</a> 网页授权access_token和普通access_token的区别</h3><ul><li><p>微信网页授权是通过OAuth2.0机制实现的，在用户授权给公众号后，公众号可以获取到一个网页授权特有的接口调用凭证（网页授权access_token），通过网页授权access_token可以进行授权后接口调用，如获取用户基本信息；</p></li><li><p>其他微信接口，需要通过基础支持中的“获取access_token”接口来获取到的普通access_token调用。</p></li></ul><h2 id="➣-具体步骤："><a href="#➣-具体步骤：" aria-hidden="true" class="header-anchor">#</a> ➣ 具体步骤：</h2><h2 id="代码配置："><a href="#代码配置：" aria-hidden="true" class="header-anchor">#</a> * 代码配置：</h2><ul><li>package.json</li></ul><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;js-sdk&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;version&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
<span class="highlighted-line">  <span class="token string">&quot;description&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>  <span class="token string">&quot;main&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;app.js&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;scripts&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;test&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;author&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;license&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;ISC&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;dependencies&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;babel-runtime&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^6.26.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;body-parser&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^1.18.2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;cheerio&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^1.0.0-rc.2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;connect-mongo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^2.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;connect-redis&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^3.3.3&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;cookie-parser&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^1.4.3&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;crypto&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^1.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ejs&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^2.5.7&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;express&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^4.16.2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;express-session&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^1.15.6&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;fs&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^0.0.1-security&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^5.0.16&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;morgan&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^1.9.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;redis&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^2.8.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;request&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^2.83.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;sha1&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^1.1.1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;util&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^0.10.3&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;utility&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^1.13.1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;devDependencies&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;babel-core&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^6.26.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;babel-plugin-transform-runtime&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^6.23.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;babel-preset-es2015&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^6.24.1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^3.9.1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp-autoprefixer&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^4.1.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp-babel&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^7.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp-concat&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^2.6.1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp-connect&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^5.2.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp-imagemin&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^4.1.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp-minify-css&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^1.2.4&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp-minify-html&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^1.0.6&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp-px2rem-plugin&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^0.4.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp-uglify&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^3.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;gulp-util&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;^3.0.8&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><ul><li>app.js</li></ul><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;body-parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="highlighted-line"><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;morgan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">const</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cookie-parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> indexRoute <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./app/routes/index.route&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'app/views'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*配置静态文件路径*/</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*配置请求日志*/</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*解析application/json格式数据*/</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*解析application/www-x-form-urlencoded格式数据*/</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>extended<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*解析cookie*/</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*解析session*/</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    secret<span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span> <span class="token comment">//建议使用随机字符串</span>
    resave<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    saveUninitialized<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    cookie<span class="token punctuation">:</span> <span class="token punctuation">{</span>maxAge<span class="token punctuation">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*配置路由*/</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> indexRoute<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Error 404, the source is not found!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app<span class="token punctuation">;</span>
</code></pre><ul><li>config/env.config.js</li></ul><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  port<span class="token punctuation">:</span><span class="token string">&quot;80&quot;</span><span class="token punctuation">,</span>
	<span class="token string">&quot;token&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;yourtoken&quot;</span><span class="token punctuation">,</span>
<span class="highlighted-line">	<span class="token string">&quot;appID&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;***&quot;</span><span class="token punctuation">,</span></span>	<span class="token string">&quot;appsecret&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;***&quot;</span><span class="token punctuation">,</span>
	<span class="token string">&quot;userAppID&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;***&quot;</span><span class="token punctuation">,</span>
	<span class="token string">&quot;userAppSecret&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;***&quot;</span>
<span class="token punctuation">}</span>
</code></pre><ul><li>app/routes/index.routes.js</li></ul><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> authMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../middlewares/auth.middleware&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="highlighted-line"><span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cheerio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cheerio'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> authMiddleware<span class="token punctuation">.</span>getCode<span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../views/index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><ul><li>app/views/index.html</li></ul><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span>doctype html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="highlighted-line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span></span>    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span>
          content<span class="token operator">=</span><span class="token string">&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;ie=edge&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Document<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    这里只是测试getCode成功与否
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre><ul><li><p>新建 app/config.access_token.json待用</p></li><li><p>新建 app/config.ticket.json待用</p></li><li><p>app/middlewares/auth.middlewares.js</p></li></ul><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">getUserInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;-----------------获取getUserInfo---------------------&gt;&quot;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-----&gt;req.access_token : '</span><span class="token operator">+</span>req<span class="token punctuation">.</span>access_token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="highlighted-line">    <span class="token keyword">let</span> access_token <span class="token operator">=</span> req<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span></span>    <span class="token keyword">let</span> openid <span class="token operator">=</span> req<span class="token punctuation">.</span>openid<span class="token punctuation">;</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://api.weixin.qq.com/sns/userinfo?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;openid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>openid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;lang=zh_CN`</span></span><span class="token punctuation">;</span>
    <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span>httpResponse<span class="token punctuation">,</span>body<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;----&gt;--通过access_token和openid获取到的用户个人信息 :&quot;</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">&quot;openid&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>openid<span class="token punctuation">,</span> <span class="token punctuation">{</span>maxAge<span class="token punctuation">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> httpOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">&quot;nickname&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>nickname<span class="token punctuation">,</span> <span class="token punctuation">{</span>maxAge<span class="token punctuation">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> httpOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">&quot;headimgurl&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>headimgurl<span class="token punctuation">,</span> <span class="token punctuation">{</span>maxAge<span class="token punctuation">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">,</span> httpOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">&quot;unionid&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>unionid<span class="token punctuation">,</span> <span class="token punctuation">{</span>maxAge<span class="token punctuation">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> httpOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="以snsapi-base为scope发起的授权"><a href="#以snsapi-base为scope发起的授权" aria-hidden="true" class="header-anchor">#</a> * 以snsapi_base为scope发起的授权</h2><h3 id="第一步：用户同意授权，获取code"><a href="#第一步：用户同意授权，获取code" aria-hidden="true" class="header-anchor">#</a> 第一步：用户同意授权，获取code</h3><ul><li>app/middleares/auth.middlewares.js</li></ul><pre class="language-js"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../config/env.config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> appid <span class="token operator">=</span> config<span class="token punctuation">.</span>appID<span class="token punctuation">;</span>
<span class="highlighted-line"><span class="token keyword">const</span> appsecret <span class="token operator">=</span> config<span class="token punctuation">.</span>appsecret<span class="token punctuation">;</span></span><span class="token comment">/*获取code*/</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">getCode</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--|cookies : '</span><span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>openid<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> back_url <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解码，解决url？后面参数返回消失问题 2.req.url 获取URL</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'获取的url路由参数为 ：'</span><span class="token operator">+</span>back_url<span class="token punctuation">)</span>
        <span class="token keyword">let</span> redirect_uri <span class="token operator">=</span> <span class="token template-string"><span class="token string">`{你的域名}/getUserInfo?back_url=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>back_url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>    <span class="token comment">//注意这里执行了getUserInfo路由</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://open.weixin.qq.com/connect/oauth2/authorize?appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;redirect_uri=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>redirect_uri<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state=STATE#wechat_redirect `</span></span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'重定向的url : '</span><span class="token operator">+</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//next();</span>
        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//res.redirect()重定向跳转 参数仅为URL时和res.location(url)一样</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h3 id="第二步：通过code换取网页授权access-token"><a href="#第二步：通过code换取网页授权access-token" aria-hidden="true" class="header-anchor">#</a> 第二步：通过code换取网页授权access_token</h3><pre class="language-js"><code><span class="token comment">/*获取access_token*/</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">getAccess_token</span> <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;------------------获取snsapi_base access_token-----------------------&gt;&quot;</span><span class="token punctuation">)</span>
<span class="highlighted-line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span></span>    <span class="token keyword">let</span> code <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`https://api.weixin.qq.com/sns/oauth2/access_token?appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appsecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;grant_type=authorization_code `</span></span><span class="token punctuation">;</span>
    <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> httpResponse<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--||--code换取的所有信息 ：'</span><span class="token operator">+</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span>access_token <span class="token operator">=</span> result<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span>
        req<span class="token punctuation">.</span>openid <span class="token operator">=</span> result<span class="token punctuation">.</span>openid<span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre><h3 id="第三步：拉取用户信息-需scope为-snsapi-userinfo"><a href="#第三步：拉取用户信息-需scope为-snsapi-userinfo" aria-hidden="true" class="header-anchor">#</a> 第三步：拉取用户信息(需scope为 snsapi_userinfo)</h3><ul><li>/getUserInfo使用了getAccess_token  getUserInfo 中间件 在code没过期的情况下可以进一步获取access_token 和个人信息</li></ul><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/getUserInfo&quot;</span><span class="token punctuation">,</span> authMiddleware<span class="token punctuation">.</span>getAccess_token<span class="token punctuation">,</span> authMiddleware<span class="token punctuation">.</span>getUserInfo<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;------------------'/getUserInfo'-----------------------&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-----&gt;|查询的url字符串参数 ：'</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="highlighted-line">    <span class="token keyword">let</span> back_url <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>back_url<span class="token punctuation">;</span></span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">in</span> req<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">!==</span> <span class="token string">&quot;back_url&quot;</span> <span class="token operator">&amp;&amp;</span> item <span class="token operator">!==</span> <span class="token string">&quot;code&quot;</span> <span class="token operator">&amp;&amp;</span> item <span class="token operator">!==</span> <span class="token string">&quot;state&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            back_url <span class="token operator">+=</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> item <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>query<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----&gt;|重新筛选路径back_url : '</span> <span class="token operator">+</span> back_url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>back_url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h2 id="以snsapi-userinfo为scope发起的授权"><a href="#以snsapi-userinfo为scope发起的授权" aria-hidden="true" class="header-anchor">#</a> * 以snsapi_userinfo为scope发起的授权</h2><ul><li>app/middlewares/accessToken.middlesware.js</li></ul><pre class="language-js"><code><span class="token keyword">let</span> weixinConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../config/env.config.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="highlighted-line"></span><span class="token comment">//获取accessToken</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">accessToken</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;------------------'获取snsapi_userinfo accessToken'-----------------------&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> valide <span class="token operator">=</span> <span class="token function">isValide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//{ code: 0, result: result.access_token } or{code:1001}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>valide<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//access_token还没过期，用以前的</span>
        req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>access_token <span class="token operator">=</span> valide<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//重新获取access_token &amp;&amp; expire_in</span>
        <span class="token keyword">let</span> appid <span class="token operator">=</span> weixinConfig<span class="token punctuation">.</span>appID<span class="token punctuation">;</span>
        <span class="token keyword">let</span> secret <span class="token operator">=</span> weixinConfig<span class="token punctuation">.</span>appsecret<span class="token punctuation">;</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=&quot;</span> <span class="token operator">+</span> appid <span class="token operator">+</span> <span class="token string">&quot;&amp;secret=&quot;</span> <span class="token operator">+</span> secret<span class="token punctuation">;</span>
        <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> response<span class="token punctuation">,</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new Date().getTime() 获得的是毫秒</span>
            result<span class="token punctuation">.</span>expires_in <span class="token operator">=</span> now <span class="token operator">+</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>expires_in <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">//expire_in一般是7200s 提前20毫秒</span>

            req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>access_token <span class="token operator">=</span> result<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span> <span class="token comment">//new access_token</span>
            req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>tokenExpired <span class="token operator">=</span> result<span class="token punctuation">.</span>expires_in<span class="token punctuation">;</span> <span class="token comment">// 7200s</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//获取ticket</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">ticket</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;------------------'获取ticket'-----------------------&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ticketResult <span class="token operator">=</span> <span class="token function">isTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ticketResult<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'已经有了ticket : '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ticketResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>ticket <span class="token operator">=</span> ticketResult<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始获取ticket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> access_token <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span>
        <span class="token keyword">let</span> _tokenResult <span class="token operator">=</span> <span class="token punctuation">{</span>
            access_token<span class="token punctuation">:</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>access_token<span class="token punctuation">,</span>
            expires_in<span class="token punctuation">:</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>tokenExpired
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=&quot;</span> <span class="token operator">+</span> access_token <span class="token operator">+</span> <span class="token string">&quot;&amp;type=jsapi&quot;</span><span class="token punctuation">;</span>
        <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> response<span class="token punctuation">,</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>errcode <span class="token operator">==</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>expires_in <span class="token operator">=</span> now <span class="token operator">+</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>expires_in <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">//   改变时间为当前时间的两小时后</span>
                fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./config/access_token.json&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>_tokenResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//fs.writeFileSync:以同步的方式将data写入文件，文件已存在的情况下，原内容将被替换。</span>
                fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./config/ticket.json&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'异步写入access_token ticket.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>ticket <span class="token operator">=</span> result<span class="token punctuation">.</span>ticket<span class="token punctuation">;</span>
                <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">isValide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//有效</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./config/access_token.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//同步读取json文件 //这里用toString的原因：读出来的数据是一堆包含着16进制数字的对象，必须通过toString转为字符串形式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>access_token <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>expires_in <span class="token operator">&amp;&amp;</span> now <span class="token operator">&lt;</span> result<span class="token punctuation">.</span>expires_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;access_token 还在7200s以内，没有过期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//access_token有效 expires_in应该指的是距离生成时间的7200秒后</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> result<span class="token punctuation">:</span> result<span class="token punctuation">.</span>access_token <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;access_token 失效&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token number">1001</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token number">1001</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">isTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./config/ticket.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;result:&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>ticket <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>expires_in <span class="token operator">&amp;&amp;</span> now <span class="token operator">&lt;</span> result<span class="token punctuation">.</span>expires_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ticket有效，沿用当前ticket.json里的ticket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> result<span class="token punctuation">:</span> result<span class="token punctuation">.</span>ticket <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ticket无效需要获取&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token number">1001</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token number">1001</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><ul><li><p>accessToken.middlesware.js写了关于获取以snsapi_userinfo为scope发起的网页授权的access_token ticket,并用fs以json字符串的形式存到本地，并检测过期时间，如果没过期就继续读取使用，如果过期就重新获取并储存在心的access_token ticket到本地</p></li><li><p>app/routes/index.routes.js</p></li></ul><pre class="language-js"><code>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;crypto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;sha1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="highlighted-line"><span class="token keyword">const</span> accessTokenMiddle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../middlewares/accessToken.middleware.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">const</span> weixin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../config/env.config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/weixin&quot;</span><span class="token punctuation">,</span> accessTokenMiddle<span class="token punctuation">.</span>accessToken<span class="token punctuation">,</span> accessTokenMiddle<span class="token punctuation">.</span>ticket<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;------------------'/weixin'-----------------------&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-----&gt;| req.query : '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ex<span class="token punctuation">,</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> appId <span class="token operator">=</span> weixin<span class="token punctuation">.</span>appID<span class="token punctuation">;</span>
        <span class="token keyword">let</span> noncestr <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;hex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> jsapi_ticket <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>ticket<span class="token punctuation">;</span>
        <span class="token keyword">let</span> timestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        timestamp <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>timestamp <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;参数 ：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>noncestr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jsapi_ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;noncestr=&quot;</span> <span class="token operator">+</span> noncestr<span class="token punctuation">,</span> <span class="token string">&quot;jsapi_ticket=&quot;</span> <span class="token operator">+</span> jsapi_ticket<span class="token punctuation">,</span> <span class="token string">&quot;timestamp=&quot;</span> <span class="token operator">+</span> timestamp<span class="token punctuation">,</span> <span class="token string">&quot;url=&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;待混淆加密的字符串 ： &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> signature <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;微信sdk签名signature ：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> result<span class="token punctuation">:</span> <span class="token punctuation">{</span> appId<span class="token punctuation">:</span> appId<span class="token punctuation">,</span> timestamp<span class="token punctuation">:</span> timestamp<span class="token punctuation">,</span> nonceStr<span class="token punctuation">:</span> noncestr<span class="token punctuation">,</span> signature<span class="token punctuation">:</span> signature <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//res.json 等同于将一个对象或数组传到给res.send()</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><ul><li>在html页面使用微信公众平台提供的API 需要引用 http://res.wx.qq.com/open/js/jweixin-1.2.0.js</li><li>在静态文件中调用分享功能的api 更多API请打开
<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421141115" target="_blank" rel="noopener noreferrer"># 微信JS-SDK说明文档</a></li><li>public/index.html</li></ul><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span>doctype html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="highlighted-line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span></span>    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span>
          content<span class="token operator">=</span><span class="token string">&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;ie=edge&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Document<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>userList<span class="token operator">...</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button style<span class="token operator">=</span><span class="token string">&quot;color:purple;&quot;</span> onclick<span class="token operator">=</span><span class="token string">&quot;clickMe()&quot;</span><span class="token operator">&gt;</span>clickMe<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;http://www.jq22.com/jquery/jquery-2.1.1.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;http://res.wx.qq.com/open/js/jweixin-1.2.0.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;../js/userList.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre><p>public/js/userList.js</p><pre class="language-js"><code><span class="token keyword">let</span> signatureUrl <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">URL</span> <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>signatureUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="highlighted-line"></span><span class="token keyword">let</span> title <span class="token operator">=</span> <span class="token string">&quot;这是分享的表标题&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> desc <span class="token operator">=</span> <span class="token string">&quot;this is description&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> shareUrl <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">;</span>
<span class="token keyword">let</span> logo <span class="token operator">=</span> <span class="token string">&quot;http://yizhenjia.com/dist/newImg/logo.png&quot;</span><span class="token punctuation">;</span>
<span class="token constant">SHARE</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> shareUrl<span class="token punctuation">,</span> logo<span class="token punctuation">)</span><span class="token punctuation">;</span> 

$<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/weixin?url=&quot;</span> <span class="token operator">+</span> <span class="token constant">URL</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wx<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            debug<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span>
            appId<span class="token punctuation">:</span> result<span class="token punctuation">.</span>result<span class="token punctuation">.</span>appId<span class="token punctuation">,</span> <span class="token comment">// 必填，公众号的唯一标识</span>
            timestamp<span class="token punctuation">:</span> result<span class="token punctuation">.</span>result<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> <span class="token comment">// 必填，生成签名的时间戳</span>
            nonceStr<span class="token punctuation">:</span> result<span class="token punctuation">.</span>result<span class="token punctuation">.</span>nonceStr<span class="token punctuation">,</span> <span class="token comment">// 必填，生成签名的随机串</span>
            signature<span class="token punctuation">:</span> result<span class="token punctuation">.</span>result<span class="token punctuation">.</span>signature<span class="token punctuation">,</span> <span class="token comment">// 必填，签名，见附录1</span>
            jsApiList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;onMenuShareAppMessage&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;onMenuShareTimeline&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chooseImage&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;scanQRCode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;getLocation&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;openLocation&quot;</span><span class="token punctuation">]</span> <span class="token comment">// 必填，需要使用的JS接口列表，所有JS接口列表见附录2</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token constant">SHARE</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> shareUrl<span class="token punctuation">,</span> logo<span class="token punctuation">)</span> <span class="token punctuation">{</span>        
    wx<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。</span>
        <span class="token comment">//分享</span>
        wx<span class="token punctuation">.</span><span class="token function">onMenuShareAppMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            title<span class="token punctuation">:</span> title<span class="token punctuation">,</span> <span class="token comment">// 分享标题</span>
            desc<span class="token punctuation">:</span> desc<span class="token punctuation">,</span> <span class="token comment">// 分享描述</span>
            link<span class="token punctuation">:</span> shareUrl<span class="token punctuation">,</span> <span class="token comment">// 分享链接</span>
            imgUrl<span class="token punctuation">:</span> logo<span class="token punctuation">,</span> <span class="token comment">// 分享图标</span>
            type<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 分享类型,music、video或link，不填默认为link</span>
            dataUrl<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 如果type是music或video，则要提供数据链接，默认为空</span>
            success<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                用户确认分享后执行的回调函数
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;分享成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            cancel<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 用户取消分享后执行的回调函数</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            fail<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;分享失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。</span>
        <span class="token comment">//alert(&quot;Error&quot;);</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>      

</code></pre><h2 id="注释："><a href="#注释：" aria-hidden="true" class="header-anchor">#</a> 注释：</h2><ul><li>#微信开发必须在微信开发者工具上开发，且只能是默认80端口，在开发中经常有80端口被占用的情况，如果有请使用</li></ul><pre class="language-js"><code>lsof <span class="token operator">-</span>i tcp<span class="token punctuation">:</span><span class="token number">80</span>
kill <span class="token operator">-</span><span class="token number">9</span> 进程
</code></pre><hr><ul><li>#如果想在手机上测试 并抓包数据 可以使用charles抓包工具</li></ul><ol><li>打开charles 点击Proxy setting 设置 port</li><li>保证手机和电脑处于同一Wi-Fi下，配置手动代理 输入IP和端口
查看ip地址 ：charles上可查看 或者终端输入ifconfig (cmd:ipconfig)</li><li>扫码或使用地址即可访问</li></ol><hr><ul><li>#在获取以snsapi_userinfo为scope发起的网页授权的时候使用的方式是fs储存到本地的方式，你也可以采用其他方式</li></ul></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/catalog/study/vuepress使用说明.html" class="prev">
          ➹ vuePress使用说明
        </a></span><span class="next"><a href="/catalog/study/browserify+gulp自动编译打包.html">
          ➹ browserify+gulp自动编译打包
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/0.c2df6edd.js" defer></script><script src="/assets/js/app.73344881.js" defer></script>
  </body>
</html>
